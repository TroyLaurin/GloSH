<html>
<head>
<script src="jquery-3.2.0.js"></script>
<script>
// helper functions
function blocktext(text) {
	return "<p>" + text.split("\n").join("</p><p>") + "</p>";
}

// Scenario logic
function Scene(title, req, goal, rules) {
	this.title = title;
	this.requirements = req;
	this.goal = goal;
	this.rules = rules;
	this.texts = [];
	this.blurb = "";

	this.horizontal = true;
	this.originX = 0;
	this.originY = 0;

	this.rooms = {};
}

function Room(key, x, y, r) {
	this.key = key;
	this.x = +x;
	this.y = +y;
	this.r = +r;

	this.tokens = [];
	this.monsters = [];
	this.visited = 1;

	this.image = new Image;
	this.image.src = "img/tile/" + key + ".png";
}

Scene.prototype.setTexts = function(texts) {
	this.texts = texts;
}
Scene.prototype.setBlurb = function(text) {
	this.blurb = text;
}
Scene.prototype.addRoom = function(room) {
	this.rooms[room.key] = room;
}

var shortSide = 48.75;
var longSide  = 84.45;
Scene.prototype.orient = function(horizontal, originX, originY) {
	this.horizontal = horizontal;
	this.originX = originX;
	this.originY = originY;
}
Scene.prototype.hexX = function(x, y) {
	if (this.horizontal) {
		return (x + (y % 2) * 0.5) * shortSide + this.originX;
	} else {
		return (x * 0.5) * longSide + this.originX;
	}
}
Scene.prototype.hexY = function(x, y) {
	if (this.horizontal) {
		return (y * 0.5) * longSide + this.originX;
	} else {
		return (y + (x % 2) * 0.5) * shortSide + this.originY;
	}
}

Scene.prototype.visit = function(tile) {
	for (var i in this.rooms) {
		var room = this.rooms[i];
		if (room.tile.tile == tile) {
			room.tile.visited = 1;
		}
	}
}

Room.prototype.addToken = function(key, x, y, r) {
	var image = new Image;
	image.src = "img/token/" + key + ".png";
	this.tokens.push({ "key": key, "x": +x, "y": +y, "r": +r, "image": image });
}

function parseSheetsScenario(values) {
	var scene = new Scene(values[0][1], values[1][1], values[3][1], values[4][1]);
	scene.setBlurb(values[2][1]);
	var texts = [];
	for (var i = 1; i < values[5].length; i++) {
		if (values[5][i] == null || values[5][i].length == 0) continue;
		texts.push({ key:[values[5][i]], text:values[6][i]});
	}
	scene.setTexts(texts);
	var horizontal = values[7][1].match(/vertical/i) ? 0 : 1;
	scene.orient(horizontal, +values[7][2], +values[7][3]);

	var room = null;
	for (var i = 9; i < values.length; i++) {
		if (values[i][0] == null || values[i][0].length == 0) continue;
		switch (values[i][0]) {
		case "Room" :
			if (room !== null) {
				scene.addRoom(room);
			}
			room = new Room(values[i][1], values[i][2], values[i][3], values[i][4]);
			break;
		case "Token" :
			room.addToken(values[i][1], values[i][2], values[i][3], values[i][4]);
			break;
		}
	}
	if (room !== null) {
		scene.addRoom(room);
	}
	return scene;
}
function keptForReference() {
	var scene = new Scene("Return to the Black Barrow", "Brute level 5 (solo character)", "Kill all enemies", "All monsters are one level lower than the scenario level.");
	scene.intro("You sniff the air as you descend the familiar stone steps, and the stale smell of death and decay fills you with anger&#8212;"+
		"an anger focused on yourself. You remember the first time you stepped down into these depths and smelled this odor. It was your first "+
		"job after you arrived in Gloomhaven. And you remember being scared by it.\nYou would never have dreamed of exposing your fear "+
		"to your companions. They were depending on you to lead the charge into your bandit foes. When you're this big, no one expects you to "+
		"feel fear, but sometimes it's inevitable.\nStill, your reaction to this place has haunted you ever since. When you began to "+
		"hear rumors about a powerful weapon hidden in the depths of the Black Barrow, you jumped at the opportunity to return and face its "+
		"dangers alone.\nYou are stronger now&#8212;more seasoned.  Walking down these steps no longer fills you with dread, only excitement. "+
		"You hope that more pathetic bandits have made this place their home since the last time you charged through these dark halls.\n"+
		"You reach the bottom of the steps and bash open the door. You are not disappointed.");
	scene.blurb("TODO");

	scene.orient(false, 32, 14);
	scene.addRoom({ tile:"L1a", x:535.5, y:392, r:90 },
			[ { token:"door-stone-v", x:7, y:7, r:90 } ], {}, {});
	scene.addRoom({ tile:"G1b", x:255,   y:420, r:-90 },
			[ { token:"door-stone-h", x:5, y:3, r:90 } ], {}, {});
	scene.addRoom({ tile:"I1b", x:281,   y:49,  r:90},
			[ { token: "coin", x:0, y:1 }, { token: "coin", x:1, y:1 }, { token: "coin", x:2, y:1 },
			  { token: "coin", x:0, y:6 }, { token: "coin", x:1, y:5 }, { token: "coin", x:2, y:6 }, ], {}, {});
	scene.visit("L1a");
	scene.visit("G1b");
	scene.visit("I1b");
	return scene;
}

</script>
<script>
// UI
$( document ).ready(function() {

var canvas = ($("#map"))[0];
var ctx = canvas.getContext('2d');

var currentScenario = new Scene("Select a scenario");

function redrawMap() {
	for (var i in currentScenario.rooms) {
		var room = currentScenario.rooms[i];
		if (!room.visited) continue;
		if (!room.image.complete) {
			room.image.onload = redrawMap;
			continue;
		}
		ctx.resetTransform();
		ctx.translate(room.x, room.y);
		ctx.rotate(room.r * Math.PI / 180);
		ctx.scale(0.25, 0.25);
		ctx.drawImage(room.image, 0, 0);
		ctx.resetTransform();
	}

	for (var i in currentScenario.rooms) {
		var room = currentScenario.rooms[i];
		if (!room.visited) continue;
		for (var j in room.tokens) {
			var token = room.tokens[j];
			if (!token.image.complete) {
				token.image.onload = redrawMap;
				continue;
			}
			ctx.resetTransform();
			var x = currentScenario.hexX(token.x, token.y);
			var y = currentScenario.hexY(token.x, token.y);
			ctx.translate(x, y);
			ctx.scale(0.1, 0.1);
			if (token.r) {
				ctx.translate(token.image.width*0.5, token.image.height*0.5);
				ctx.rotate(token.r * Math.PI / 180);
				ctx.translate(-token.image.width*0.5, -token.image.height*0.5);
			}
			ctx.drawImage(token.image, 0, 0);
		}
	}
	ctx.resetTransform();
}

function setScenario(scene) {
	currentScenario = scene;
	$("#title").text(scene.title);
	$("#requirements").text(scene.requirements);
	$("#goal").text(scene.goal);
	$("#rules").text(scene.rules);
	$("#introduction").html("");
	for (var i in scene.texts) {
		var text = scene.texts[i];
		if (text.key == +text.key) {
			$("<span class='text-section'><h3 class='numbered'>" + text.key + "</h3>" + blocktext(text.text) + "</span>").appendTo("#introduction");
		} else {
			$("<span class='text-section'><h3>" + text.key + "</h3>" + blocktext(text.text) + "</span>").appendTo("#introduction");
		}
	}
	redrawMap();
}

$( "li" ).click(function() {
	setTab($(this).attr("id"));
});

var APIKEY="AIzaSyDge-HgZJGs2bPmdpqf2rvVJ_cagmPN5es";

function previewScenario(pack, key) {
	$("#scenario-description").html("Loading...");
	var parts = pack.split(":");
	switch (parts[0]) {
	case "google" :
		// TODO caching
		$.ajax({
			type: "GET",
			dataType: "jsonp",
			url: "https://sheets.googleapis.com/v4/spreadsheets/" + parts[1] + "/values/" + key + "!A1:Z1000?key=" + APIKEY,
			success: function(data) {
				var scene = parseSheetsScenario(data.values);
				$("<h1>" + scene.title + "</h1>").appendTo("#scenario-description");
				$("<span class='requirement'><h3>Requirements:</h3>" + scene.requirements + "</span>").appendTo("#scenario-description");
				$(blocktext(scene.blurb)).appendTo("#scenario-description");
				var startbutton = $("<button class='startbutton'>Start this scenario</button>");
				startbutton.appendTo("#scenario-description");
				startbutton.click(function() { setScenario(scene) });
			}
			});
		break;
	}
}

$("#scenario-pack").change(function(event) {
	var pack=$("#scenario-pack").val();
	if (pack.length == 0) {
		$("#pack-options").html("");
		return;
	}
	$("#pack-description").html("Loading...");
	$("#scenario-description").html("");
	$("#pack-options").html("");
	var parts = pack.split(":");
	switch (parts[0]) {
	case "google" :
		// TODO caching
		$.ajax({ 
			type: "GET",
			dataType: "jsonp",
			url: "https://sheets.googleapis.com/v4/spreadsheets/" + parts[1] + "/values/A1:B1000?key=" + APIKEY,
			success: function(data) {
				$("#pack-description").html(blocktext(data.values[0][0]));
				$("#pack-options").html("");
				for (var i = 1; i < data.values.length; i++) {
					var val = data.values[i];
					var option = $("<label class='pack-option'><input name='scenario' type='radio' value='" + val[0] + "' />" + val[1] + "</label>");
					option.appendTo("#pack-options");
					option.change(function() { var key = $("input[type=radio][name=scenario]:checked").val(); previewScenario(pack, key); });
				}
			}
			});
		break;
	
	default :
		$("#pack-description").html("<span class='pack-option'>Parse error</span>");
	}
});

//$( "#load-scenario" ).click(function() {
//	setScenario(loadScene());
//});

$("#scenario-pack").val("");
});
</script>
<link href="https://fonts.googleapis.com/css?family=Pirata+One" rel="stylesheet" />
<link href="glosh.css" rel="stylesheet" />
</style>
</head>

<body>
<div class="tabholder"><div class="spacer">
	<div id="scenario-setup" action="#">
		<h3>Scenario pack:</h3>
		<select name="pack" id="scenario-pack" autocomplete="off">
			<option value="" selected>Choose a pack</option>
			<option value="google:1nyf5hgqrfoQGpm9cmLwsw-EK6GVD5uOoYW7HmptGdlU">Solo scenarios</option>
			<option value="google:1KeaoY3G4kWTtQyEnHQ9-76D7W28E0G69QZ2Dcu_g-y4">Kickstarter scenarios</option>
		</select>
		<div id="pack-description"></div>
		<div id="pack-options">
		</div>

		<div id="scenario-description"></div>
	</div>
	<div id="tab-scenario-content">
		<div><h3>Requirements:</h3>&nbsp;<span id="requirements"></span></div>
		<div><h3>Goal:</h3>&nbsp;<span id="goal"></span></div>
		<div><h3>Special Rules:</h3>&nbsp;<span id="rules"></span></div>
		<div id="introduction"></div>
	</div>
</div></div>
<div class="mapholder">
	<h1 id="title">Select a scenario...</h2>
	<div class="spacer">
		<canvas id="map" width="4000" height="4000"></canvas>
	</div>
</div>
</body>
</html>
